{{ define "main" }}
<!-- Include only the reset -->
<!-- reset.css within of the satellite.css -->
<link rel="stylesheet" href="/assets/algolia.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css?v=3.5.7" crossorigin="anonymous">
<div class="posts post-content searchPage searchAlgolia">
    <div id="searchbox" class="searchboxAlgolia">
        <!-- SearchBox widget will appear here -->
    </div>
    <div id="hits" class="hitsAlgolia">
        <div class="ais-Hits">
            <ol class="ais-Hits-list">
                <li class="ais-Hits-item">
                    <div class='timeline'>
                        <div class='talks__avatar'>
                            <img src='https://images.eallion.com/eallion.jpg' alt=''>
                        </div>
                        <div class='talks__content'>
                            <div class='talks__text'>
                                <div class='talks__userinfo'>
                                    <div>Charles Chin</div>
                                    <div><svg viewBox='0 0 24 24' aria-label='认证账号' class='talks__verify'><g><path d='M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z'></path></g></svg></div>
                                    <div class='talks__id'>@eallion</div>
                                </div>
                                <p>正在从 Algolia CDN 加载……<i class="iconfont icon-loading"></i></p>
                            </div>
                        </div>
                    </div>
                </li>
            </ol>
        </div>
        <!-- Hits widget will appear here -->
    </div>
    <div id="pagination" class="paginationAlgolia">
        <!-- pagination widget will appear here -->
    </div>
</div>
<!-- Algolia for the search only version -->
<script type="text/javascript" src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js?v=3.6.0"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/algoliasearch/4.13.0/algoliasearch-lite.umd.min.js?v=4.13.0"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/instantsearch.js/4.40.5/instantsearch.production.min.js?v=4.40.5"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/moment.js/2.29.3/moment.min.js?v=2.29.3"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/pangu/4.0.7/pangu.min.js?v=4.0.7"></script>
<script>
    // 今日诗词
    function getData() {
        var xhr = new XMLHttpRequest();
        xhr.open('get', 'https://v2.jinrishici.com/one.json', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                var title =  document.getElementById('poemTitle');
                var poemSentence = document.getElementById('poemSentence');
                var poem_info = document.getElementById('poem_info');
                title.innerHTML ='《<a href="https://www.google.com/search?q=' + result.data.origin.author + ' ' + result.data.origin.title + '" target="_blank" rel="noopener noreferrer">' + result.data.origin.title + '</a>》：';
                poemSentence.innerHTML = '「<a href="https://www.google.com/search?q=' + result.data.content + '" target="_blank" rel="noopener noreferrer">' + result.data.content + '</a>」';
                poem_info.innerHTML = '【' + result.data.origin.dynasty + '】' + result.data.origin.author;
            }
        };
        xhr.send();
    }
    // 每 10 秒刷新一次
    // setInterval(getData, 1000*10);
    window.onload = getData();
</script>
<script>
    const searchClient = algoliasearch(
        "ZHP6RM1ABL",
        "1d5887e05145f909a97929fe3d4f135a"
    );

    const search = instantsearch({
        indexName: "talk",
        searchClient,
    });

    // autocorrect: false
    // moment.js locale
    moment.updateLocale('zh-cn', {
        meridiem: function (hour, minute, isLowercase) {
            if (hour < 6) {
                return "凌晨";
            } else if (hour < 9) {
                return "早上";
            } else if (hour < 11 && minute < 30) {
                return "上午";
            } else if (hour < 13 && minute < 30) {
                return "中午";
            } else if (hour < 18) {
                return "下午";
            } else {
                return "晚上";
            }
        }
    });
    // moment.js twitter plugin
    (function () {
        var day, formats, hour, initialize, minute, second, week;
        second = 1e3;
        minute = 6e4;
        hour = 36e5;
        day = 864e5;
        week = 6048e5;
        year = new Date().getFullYear();
        formats = {
            seconds: {
                short: ' 秒前',
                long: ' 秒前'
            },
            minutes: {
                short: ' 分前',
                long: ' 分前'
            },
            hours: {
                short: ' 小时前',
                long: ' 小时前'
            },
            days: {
                short: ' 天前',
                long: ' 天前'
            }
        };

        initialize = function (moment) {
            var twitterFormat;
            twitterFormat = function (format) {
                var diff, num, unit, unitStr;
                diff = Math.abs(this.diff(moment()));
                unit = null;
                num = null;
                if (diff <= second) {
                    unit = 'seconds';
                    num = 1;
                } else if (diff < minute) {
                    unit = 'seconds';
                } else if (diff < hour) {
                    unit = 'minutes';
                } else if (diff < day) {
                    unit = 'hours';
                } else if (format === 'short') {
                    if (diff < week) {
                        unit = 'days';
                    } else if (this.year() == year) {
                        return this.format('MM月DD日，HH:mm · a ');
                    } else {
                        return this.format('YYYY年MM月DD日，HH:mm · a ');
                    }
                } else {
                    return this.format('YYYY年MM月DD日，HH:mm · a ');
                }
                if (!(num && unit)) {
                    num = moment.duration(diff)[unit]();
                }
                unitStr = unit = formats[unit][format];
                if (format === 'long' && num > 1) {
                    unitStr += 's';
                }
                return num + unitStr;
            };
            moment.fn.twitterLong = function () {
                return twitterFormat.call(this, 'long');
            };
            moment.fn.twitter = moment.fn.twitterShort = function () {
                return twitterFormat.call(this, 'short');
            };
            return moment;
        };

        if (typeof define === 'function' && define.amd) {
            define('moment-twitter', ['moment'], function (moment) {
                return this.moment = initialize(moment);
            });
        } else if (typeof module !== 'undefined') {
            module.exports = initialize(require('moment'));
        } else if (typeof window !== "undefined" && window.moment) {
            this.moment = initialize(this.moment);
        }

    }).call(this);

    // --- Define some custom helpers ---
    const hitTemplate = function (hit) {
        // moment twitter 插件处理相对时间
        let date = "";
        if (hit.date) {
            //format date with moment.js
            date = moment(hit.date).twitter();
        }
        // 处理发布来源
        const fromValue = (hit._highlightResult.from.value).toLowerCase();
        function getFrom(f) {
            return {
                'chrome': '<a href="https://chrome.google.com/webstore/detail/ispeak-bber%E6%97%B6%E5%85%89%E6%9C%BA/mmehomnjakoijcfmmofbmkaigcdkkbke" target="_blank" rel="noopener noreferrer">Chrome</a>',
                'talker': '<a href="https://talk.eallion.com/" target="_blank" rel="noopener noreferrer">Talker</a>',
                'android': '<a href="https://play.google.com/store/apps/details?id=ch.rmy.android.http_shortcuts" target="_blank" rel="noopener noreferrer">Android</a>',
                'vscode': '<a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client" target="_blank" rel="noopener noreferrer">VS Code</a>',
                'github': '<a href="https://github.com/eallion/" target="_blank" rel="noopener noreferrer">GitHub</a>',
                'bilibili': '<a href="https://bilibili.com/" target="_blank" rel="noopener noreferrer">Bilibili</a>',
                'utools': '<a href="https://github.com/imxw/uTools-scripts" target="_blank" rel="noopener noreferrer">uTools</a>',
                'alfred': '<a href="https://immmmm.com/bb-by-alfred/" target="_blank" rel="noopener noreferrer">Alfred</a>',
                'iphone': '<a href="https://www.icloud.com/shortcuts/3cfcbc36a6a24e0a8721bfeef8dfc6cf" target="_blank" rel="noopener noreferrer">iPhone</a>',
                'ios': '<a href="https://www.icloud.com/shortcuts/3cfcbc36a6a24e0a8721bfeef8dfc6cf" target="_blank" rel="noopener noreferrer">iPhone</a>',
                '微信': '<a href="http://mp.weixin.qq.com/profile?src=3&timestamp=1652263089&ver=1&signature=KsHNmTgeJ6AJ6qNsDFcsI*XO-NtUW588wxZEjiB26S76k6yo16AMndCl*t1bX94pV9JgoS1dHB2viLCPDd*iqQ==" target="_blank" rel="noopener noreferrer">微信</a>',
                '豆瓣': '<a href="https://douban.com" target="_blank" rel="noopener noreferrer">豆瓣</a>',
                '饭否': '<a href="https://fanfou.com" target="_blank" rel="noopener noreferrer">饭否</a>',
                'telegram': '<a href="https://t.me/eallion_bot" target="_blank" rel="noopener noreferrer">Telegram</a>',
                'twitter': '<a href="https://twitter.com/" target="_blank" rel="noopener noreferrer">Twitter</a>',
                'qq 空间 qzone.qq.com': '<a href="https://qzone.qq.com/" target="_blank" rel="noopener noreferrer">Qzone</a>',
                '微博 weibo.com': '<a href="https://weibo.com" target="_blank" rel="noopener noreferrer">微博</a>',
                '抖音': '<a href="https://douyin.com" target="_blank" rel="noopener noreferrer">抖音</a>',
                '小红书': '<a href="https://www.xiaohongshu.com/" target="_blank" rel="noopener noreferrer">小红书</a>',
                'tiktok': '<a href="https://tiktok.com" target="_blank" rel="noopener noreferrer">TikTok</a>',
                'instagram': '<a href="https://instagram.com" target="_blank" rel="noopener noreferrer">Instagram</a>',
            }[f]
        }
        const from = getFrom(fromValue) ? getFrom(fromValue) : fromValue;

        // 处理嘀咕正文
        const content = hit._highlightResult.content.value;
        const talksContent = urlToLink(content);
        const talks = pangu.spacing(talksContent);
        // 图片和链接
        function urlToLink(str) {
            //去除<img>标签，留 src 链接
            var re_forimg = /\<[img|IMG].*?src=[\'|\"](https\:\/\/.*?(?:[\.jpg|\.jpeg|\.png|\.gif|\.webp|\.jfif|\.bmp]))[\'|\"].*?[\/]?>/g;
            str = str.replace(re_forimg, '$1');
            //去 ![]() 标签，留图片链接
            var re_formd = /^!\[(.*)\]\((.*)\)/g;
            str = str.replace(re_formd, '$2');
            //处理图片链接，添加 a 标签并添加灯箱效果
            var re_forpic = /\bhttps?:[^:<>"]*\/([^:<>"]*)(\.(jpe?g)|(png)|(jfif)|(bmp)|(webp))/g;
            str = str.replace(re_forpic, function (imgurl) {
                return '<a href="' + imgurl + '"><img src="' + imgurl + '"></a>';
            });
            //多个换行符替换为一个
            str = str.replace(/\n\n/g, "\n");
            str = str.replace(/\<p\>\<\/p\>/g, '');
            //处理普通链接，添加 a 标签供跳转
            var re = /\bhttps?:\/\/(?!\S+(?:jpe?g|png|bmp|gif|webp|jfif|gif))\S+/g;
            str = str.replace(re, function (website) {
                return "<i class='iconfont icon-link'></i><a href='" + website + "' target='_blank' rel='noopener noreferrer'>链接</a>";
            });
            //去掉 Share 标签
            var re_share = /(\#share)|(\#Share)/g;
            str = str.replace(re_share, function (share) {
                return "<i class='iconfont icon-fenxiang'></i>";
            });
            //微信表情
            // str = qqWechatEmotionParser(str)
            return str;
        }
        return `
        <div class="timeline">
            <div class="talks__avatar">
                <img src="https://images.eallion.com/eallion.jpg" alt="">
            </div>
            <div class="talks__content">
                <div class="talks__text">
                    <div class="talks__userinfo">
                        <div>Charles Chin</div>
                        <div><svg viewBox="0 0 24 24" aria-label="认证账号" class="talks__verify"><g><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"></path></g></svg></div>
                        <div class="talks__id">@eallion</div>
                    </div>
                    <p>${talks}</p>
                </div>
                <div class="talks__meta">
                    <small class="talks__date">${date} · 来自「${from}」</small>
                </div>
            </div>
        </div>
        `;
    };
    // autocorrect: true

    search.addWidgets([
        instantsearch.widgets.searchBox({
            container: "#searchbox",
        }),

        instantsearch.widgets.hits({
            container: "#hits",
            attribute: "content",
            escapeHTML: false,
            templates: {
                empty: "<div class='timeline'><div class='talks__avatar'><img src='https://images.eallion.com/eallion.jpg' alt=''></div><div class='talks__content'><div class='talks__text'><div class='talks__userinfo'><div>Charles Chin</div><div><svg viewBox='0 0 24 24' aria-label='认证账号' class='talks__verify'><g><path d='M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z'></path></g></svg></div><div class='talks__id'>@eallion</div></div><p>我没有这样的嘀咕……</p></div></div></div>",
                item: hitTemplate,
            },
        }),
        instantsearch.widgets.pagination({
            container: "#pagination",
            padding: 2,
            scrollTo: 'header'
        }),
    ]);

    search.start();
</script>
{{ end }}
