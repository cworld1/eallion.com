{{ define "main" }}

<div class="posts post post-content talks">
    <h2 class="post-title">{{ .Title }}</h2>
    <blockquote class="hidden">Keso：“我按我的兴趣写，你用你的智商读。我没有兴趣误导谁，嘀咕页面谢绝互动。”</blockquote>
    <div class="talks__search">
        <p class="count">共嘀咕了 <span id="count-data">0</span> 条：</p>
        <div class="search-talks">
            <input type="text" class="search-input" id="talkSearch" placeholder="我都嘀咕了啥……">
            <button class="search-btn">
              <i class="iconfont icon-search"></i>
            </button>
            <button class="search-clear" onclick="clearInput()">
              <i class="iconfont icon-clear"></i>
            </button>
          </div>
    </div>
    <ul id="talks">
        <!-- 嘀咕加载在这里 -->
    </ul>
    <div id="load-more">
        <button class="iconfont talksBtn"><span>加 载 更 多</span></button>
    </div>
</div>
<script>
    // 今日诗词
    function getData() {
        var xhr = new XMLHttpRequest();
        xhr.open('get', 'https://v2.jinrishici.com/one.json', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                var result = JSON.parse(xhr.responseText);
                var title = document.getElementById('poemTitle');
                var poemSentence = document.getElementById('poemSentence');
                var poem_info = document.getElementById('poem_info');
                title.innerHTML = '《<a href="https://www.google.com/search?q=' + result.data.origin.author + ' ' + result.data.origin.title + '" target="_blank" rel="noopener noreferrer">' + result.data.origin.title + '</a>》：';
                poemSentence.innerHTML = '「<a href="https://www.google.com/search?q=' + result.data.content + '" target="_blank" rel="noopener noreferrer">' + result.data.content + '</a>」';
                poem_info.innerHTML = '【' + result.data.origin.dynasty + '】' + result.data.origin.author;
            }
        };
        xhr.send();
    }
    // 每 10 秒刷新一次
    // setInterval(getData, 1000*10);
    window.onload = getData();
</script>
<script type="text/javascript" src="/assets/moment.min.js?v=2.29.3"></script>
<script type="text/javascript" src="/assets/pangu.min.js?v=4.0.7"></script>
<script type="text/javascript" src="//imgcache.qq.com/qcloud/cloudbase-js-sdk/1.7.1/cloudbase.js"></script>
<script type="text/javascript" src="//imgcache.qq.com/qcloud/cloudbase-js-sdk/1.7.1/cloudbase.auth.js"></script>
<script type="text/javascript" src="//imgcache.qq.com/qcloud/cloudbase-js-sdk/1.7.1/cloudbase.database.js"></script>

<script>
    // 处理发布时间 moment.js
    // moment.js locale
    moment.updateLocale('zh-cn', {
        meridiem: function (hour, minute, isLowercase) {
            if (hour < 6) {
                return "凌晨";
            } else if (hour < 9) {
                return "早上";
            } else if (hour < 11 && minute < 30) {
                return "上午";
            } else if (hour < 13 && minute < 30) {
                return "中午";
            } else if (hour < 18) {
                return "下午";
            } else {
                return "晚上";
            }
        }
    });
    // moment.js twitter plugin
    (function () {
        var day, formats, hour, initialize, minute, second, week;
        second = 1e3;
        minute = 6e4;
        hour = 36e5;
        day = 864e5;
        week = 6048e5;
        year = new Date().getFullYear();
        formats = {
            seconds: {
                short: ' 秒前',
                long: ' 秒前'
            },
            minutes: {
                short: ' 分前',
                long: ' 分前'
            },
            hours: {
                short: ' 小时前',
                long: ' 小时前'
            },
            days: {
                short: ' 天前',
                long: ' 天前'
            }
        };

        initialize = function (moment) {
            var twitterFormat;
            twitterFormat = function (format) {
                var diff, num, unit, unitStr;
                diff = Math.abs(this.diff(moment()));
                unit = null;
                num = null;
                if (diff <= second) {
                    unit = 'seconds';
                    num = 1;
                } else if (diff < minute) {
                    unit = 'seconds';
                } else if (diff < hour) {
                    unit = 'minutes';
                } else if (diff < day) {
                    unit = 'hours';
                } else if (format === 'short') {
                    if (diff < week) {
                        unit = 'days';
                    } else if (this.year() == year) {
                        return this.format('MM月DD日，HH:mm · a ');
                    } else {
                        return this.format('YYYY年MM月DD日，HH:mm · a ');
                    }
                } else {
                    return this.format('YYYY年MM月DD日，HH:mm · a ');
                }
                if (!(num && unit)) {
                    num = moment.duration(diff)[unit]();
                }
                unitStr = unit = formats[unit][format];
                if (format === 'long' && num > 1) {
                    unitStr += 's';
                }
                return num + unitStr;
            };
            moment.fn.twitterLong = function () {
                return twitterFormat.call(this, 'long');
            };
            moment.fn.twitter = moment.fn.twitterShort = function () {
                return twitterFormat.call(this, 'short');
            };
            return moment;
        };

        if (typeof define === 'function' && define.amd) {
            define('moment-twitter', ['moment'], function (moment) {
                return this.moment = initialize(moment);
            });
        } else if (typeof module !== 'undefined') {
            module.exports = initialize(require('moment'));
        } else if (typeof window !== "undefined" && window.moment) {
            this.moment = initialize(this.moment);
        }

    }).call(this);

    // 处理发布来源
    function getFrom(f) {
        return {
            'chrome': '<a href="https://chrome.google.com/webstore/detail/ispeak-bber%E6%97%B6%E5%85%89%E6%9C%BA/mmehomnjakoijcfmmofbmkaigcdkkbke" target="_blank" rel="noopener noreferrer">Chrome</a>',
            'talker': '<a href="https://talk.eallion.com/" target="_blank" rel="noopener noreferrer">Talker</a>',
            'android': '<a href="https://play.google.com/store/apps/details?id=ch.rmy.android.http_shortcuts" target="_blank" rel="noopener noreferrer">Android</a>',
            'vscode': '<a href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client" target="_blank" rel="noopener noreferrer">VS Code</a>',
            'github': '<a href="https://github.com/eallion/" target="_blank" rel="noopener noreferrer">GitHub</a>',
            'bilibili': '<a href="https://bilibili.com/" target="_blank" rel="noopener noreferrer">Bilibili</a>',
            'utools': '<a href="https://github.com/imxw/uTools-scripts" target="_blank" rel="noopener noreferrer">uTools</a>',
            'alfred': '<a href="https://immmmm.com/bb-by-alfred/" target="_blank" rel="noopener noreferrer">Alfred</a>',
            'iphone': '<a href="https://www.icloud.com/shortcuts/3cfcbc36a6a24e0a8721bfeef8dfc6cf" target="_blank" rel="noopener noreferrer">iPhone</a>',
            'ios': '<a href="https://www.icloud.com/shortcuts/3cfcbc36a6a24e0a8721bfeef8dfc6cf" target="_blank" rel="noopener noreferrer">iPhone</a>',
            '微信': '<a href="http://mp.weixin.qq.com/profile?src=3&timestamp=1652263089&ver=1&signature=KsHNmTgeJ6AJ6qNsDFcsI*XO-NtUW588wxZEjiB26S76k6yo16AMndCl*t1bX94pV9JgoS1dHB2viLCPDd*iqQ==" target="_blank" rel="noopener noreferrer">微信</a>',
            '豆瓣': '<a href="https://douban.com" target="_blank" rel="noopener noreferrer">豆瓣</a>',
            '饭否': '<a href="https://fanfou.com" target="_blank" rel="noopener noreferrer">饭否</a>',
            'telegram': '<a href="https://t.me/eallion_bot" target="_blank" rel="noopener noreferrer">Telegram</a>',
            'twitter': '<a href="https://twitter.com/" target="_blank" rel="noopener noreferrer">Twitter</a>',
            'qq 空间 qzone.qq.com': '<a href="https://qzone.qq.com/" target="_blank" rel="noopener noreferrer">Qzone</a>',
            'qq 空间': '<a href="https://qzone.qq.com/" target="_blank" rel="noopener noreferrer">Qzone</a>',
            'qzone': '<a href="https://qzone.qq.com/" target="_blank" rel="noopener noreferrer">Qzone</a>',
            '微博 weibo.com': '<a href="https://weibo.com" target="_blank" rel="noopener noreferrer">微博</a>',
            '微博': '<a href="https://weibo.com" target="_blank" rel="noopener noreferrer">微博</a>',
            'weibo': '<a href="https://weibo.com" target="_blank" rel="noopener noreferrer">微博</a>',
            '抖音': '<a href="https://douyin.com" target="_blank" rel="noopener noreferrer">抖音</a>',
            '小红书': '<a href="https://www.xiaohongshu.com/" target="_blank" rel="noopener noreferrer">小红书</a>',
            'tiktok': '<a href="https://tiktok.com" target="_blank" rel="noopener noreferrer">TikTok</a>',
            'instagram': '<a href="https://instagram.com" target="_blank" rel="noopener noreferrer">Instagram</a>',
        }[f]
    }

    // 图片和链接
    function urlToLink(str) {
        //去除<img>标签，留 src 链接
        var re_forimg = /\<[img|IMG].*?src=[\'|\"](https\:\/\/.*?(?:[\.jpg|\.jpeg|\.png|\.gif|\.webp|\.jfif|\.bmp]))[\'|\"].*?[\/]?>/g;
        str = str.replace(re_forimg, '$1');
        //去 ![]() 标签，留图片链接
        var re_formd = /^!\[(.*)\]\((.*)\)/g;
        str = str.replace(re_formd, '$2');
        //处理图片链接，添加 a 标签并添加灯箱效果
        var re_forpic = /\bhttps?:[^:<>"]*\/([^:<>"]*)(\.(jpe?g)|(png)|(jfif)|(bmp)|(webp))/g;
        str = str.replace(re_forpic, function (imgurl) {
            return '<div id="gallery" class="gallery"><a href="' + imgurl + '"><img src="' + imgurl + '"></a></div>';
        });
        //多个换行符替换为一个
        str = str.replace(/\n\n/g, "\n");
        str = str.replace(/\<p\>\<\/p\>/g, '');
        //处理普通链接，添加 a 标签供跳转
        var re = /\bhttps?:\/\/(?!\S+(?:jpe?g|png|bmp|gif|webp|jfif|gif))\S+/g;
        str = str.replace(re, function (website) {
            return "<i class='iconfont icon-link'></i><a href='" + website + "' target='_blank' rel='noopener noreferrer'>链接</a>";
        });
        //去掉 Share 标签
        // var re_share = /(\#share)|(\#Share)/g;
        // str = str.replace(re_share, function (share) {
        //     return "#";
        // });
        //微信表情
        // str = qqWechatEmotionParser(str)
        return str;
    }

    // 腾讯云开发 Cloudbase
    // 初始化
    const app = cloudbase.init({
        env: 'eallion-8gkunp4re49bae66' //这里是你的环境 id
    })
    app.auth({
        persistence: "none"
    }).anonymousAuthProvider().signIn().then(() => {
        //定义数据对象
        const db = app.database()
        //选择数据表
        const collection = db.collection('talks')
        /**
         * 定义基本变量
         * count | int，数目
         * per | int，每页显示项目数
         * page | int，第几页
         */
        var count = 0,
            per = 10,
            page = 1
        /**
         * 获取数目
         */
        collection.count(function (err, res) {
            count = res.total
            var countData = document.getElementById('count-data')
            countData.textContent = count
            getList()
            // 获取页数，每页 10 条
            totalPage = Math.ceil(count / 10)
        })
        /**
         * 封装获取数据函数
         */
        function getList() {
            if ((page - 1) * per >= count) {
                return
            }
            var date
            var talks=''
            collection.limit(per).skip((page - 1) * per).orderBy('date', 'desc').get().then((res) => {
                (res.data).forEach(item => {
                    talksContent = pangu.spacing(urlToLink(item.content))
                    talksDate = moment(item.date).twitter()
                    fromValue = (item.from).toLowerCase()
                    talksFrom = getFrom(fromValue) ? getFrom(fromValue) : fromValue
                    talkList = '<div class="talks__avatar"><img src="https://images.eallion.com/eallion.jpg" alt=""></div><div class="talks__content"><div class="talks__text"><div class="talks__userinfo"><div>Charles Chin</div><div><svg viewBox="0 0 24 24" aria-label="认证账号" class="talks__verify"><g><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"></path></g></svg></div><div class="talks__id">@eallion</div></div><p>' + talksContent + '</p></div><div class="talks__meta"><small class="talks__date">' + talksDate + ' · 来自「' + talksFrom + '」</small></div></div>'
                    var talks = document.getElementById('talks')
                    talks.innerHTML += ('<li class="timeline page-'+ page +'">' + talkList + '</li>')
                });

                if (page > 1) {
                    var currentPage = document.querySelector('.timeline.page-' + page)
                    window.scrollTo(0, currentPage.offsetTop - 20)
                }

                if (page * per >= count) {
                    var loadMore = document.getElementById('load-more')
                    if (loadMore.parentNode !== null) {
                        loadMore.parentNode.removeChild(loadMore);
                      }
                    return
                }

                page++

                // baguetteBox 灯箱 Issue: #190 先销毁再初始化
                baguetteBox.destroy()
                baguetteBox.run('.gallery', {
                    // Custom options
                    buttons: false,
                    noScrollbars: true,
                    fullScreen: false,
                    filter: /.*/i
                });

            });
        }

        function getSerList(ser){
            var talksStart = document.getElementById('talks')
                talksStart.innerHTML=('')
            var date
            var talks=''
            collection.where({
              content: new db.RegExp({
                regexp: ser,
                options: 'i'
              })
            }).limit(20).orderBy('date','desc').get().then((res) => {
              (res.data).forEach(item => {
                talksContent = pangu.spacing(urlToLink(item.content))
                    talksDate = moment(item.date).twitter()
                    fromValue = (item.from).toLowerCase()
                    talksFrom = getFrom(fromValue) ? getFrom(fromValue) : fromValue
                    talkList = '<div class="talks__avatar"><img src="https://images.eallion.com/eallion.jpg" alt=""></div><div class="talks__content"><div class="talks__text"><div class="talks__userinfo"><div>Charles Chin</div><div><svg viewBox="0 0 24 24" aria-label="认证账号" class="talks__verify"><g><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"></path></g></svg></div><div class="talks__id">@eallion</div></div><p>' + talksContent + '</p></div><div class="talks__meta"><small class="talks__date">' + talksDate + ' · 来自「' + talksFrom + '」</small></div></div>'
                    var talks = document.getElementById('talks')
                    talks.innerHTML += ('<li class="timeline page-'+ page +'">' + talkList + '</li>')
              });
            });
        }

        var buttonLoad = document.getElementById('load-more')
        buttonLoad.addEventListener('click', function () {
            getList()
        }, false);

        document.addEventListener('keyup', function (event) {
          if (event.keyCode == "13") {
            var removeSearched = document.getElementById('talks')
                function removeAllChildNodes(removeSearched) {
                    while (removeSearched.firstChild) {
                        removeSearched.removeChild(removeSearched.firstChild);
                    }
                }
            var ser = document.getElementById('talkSearch').value
            if(ser !== ''){
              getSerList(ser)
            }else{
                var talksEmpty = document.getElementById('talks')
                talksEmpty.innerHTML = ('请输入内容');
            }
          }
        })
    }).catch(err => {
        console.log(err)
    });
</script>
<script>
    function clearInput() {
        const talkSearch = document.getElementById('talkSearch');
        talkSearch.value = '';
    }
</script>
{{ end }}
