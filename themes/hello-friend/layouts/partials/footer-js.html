<script type="text/javascript" src="/assets/main.js"></script>

{{ if not (eq .Params.gushici true) }}

<script>
/**
 * Lately.js - Native JavaScript, only 800Byte but simple and easy to use Timeago plugin
 *
 * @name Lately.js
 * @version 2.5.2
 * @author Tokin (Tokinx)
 * @license MIT License - http://www.opensource.org/licenses/mit-license.php
 *
 * For usage and examples, visit:
 * https://tokinx.github.io/lately/
 *
 * Copyright (c) 2017, biji.io
 */
 (() => {
    window.Lately = new function () {
        this.lang = {
            second: "秒",
            minute: "分钟",
            hour: "小时",
            day: "天",
            month: "个月",
            year: "年",
            ago: "前",
            error: "NaN"
        };
        const format = (date) => {
            date = new Date(_val(date));
            const floor = (num, _lang) => Math.floor(num) + _lang,
                obj = new function () {
                    this.second = (Date.now() - date.getTime()) / 1000;
                    this.minute = this.second / 60;
                    this.hour = this.minute / 60;
                    this.day = this.hour / 24;
                    this.month = this.day / 30;
                    this.year = this.month / 12
                },
                key = Object.keys(obj).reverse().find(_ => obj[_] >= 1);
            return (key ? floor(obj[key], this.lang[key]) : this.lang.error) + this.lang.ago;
        },
            _val = (date) => {
                date = new Date(date && (typeof date === 'number' ? date : date.replace(/-/g, '/').replace('T', ' ')));
                return isNaN(date.getTime()) ? false : date.getTime();
            };
        return {
            init: ({ target = "time", lang } = {}) => {
                if (lang) this.lang = lang;
                for (let el of document.querySelectorAll(target)) {
                    const date = _val(el.dateTime) || _val(el.title) || _val(el.innerHTML) || 0;
                    if (!date) return;
                    el.title = new Date(date).toLocaleString();
                    el.innerHTML = format(date);
                }
            },
            format
        }
    }
})();

// 嘀咕首页 Json 版
// remote json https://6561-eallion-8gkunp4re49bae66-1251347414.tcb.qcloud.la/json/talks.json

let jsonUrl = "https://memos.eallion.com/api/memo?creatorId=101&rowStatus=NORMAL&limit=10" + "&t=" + Date.parse(new Date())
let xhrTalks = new XMLHttpRequest();
xhrTalks.open('get', jsonUrl, true);
xhrTalks.onload = function(res) {
if (this.status >= 200 && this.status < 400) {
    let res = JSON.parse(this.response);
    let talksCount = res.count;
    let talksContainer = document.querySelector('#index-talk');
    let talksHtml = '';
    res.data.forEach(function(item, i) {
        let d = new Date(item.createdTs * 1000);
        let date = d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
        let dataTime = '<span class="datatime">' + date + '</span>';
        talksHtml += '<div class="item item-' + (i + 1) + '">' + dataTime + '： <a href="https://eallion.com/memos/" target="_blank" rel="noopener noreferrer">' + urlToLink(item.content) + '</a></div>';
    });

    // Inject the string html into the container parent element.
    if(talksContainer) {
        talksContainer.innerHTML = talksHtml;
    }
}

window.Lately && Lately.init({ target: '.datatime' });

function urlToLink(str) {
    var re = /\bhttps?:\/\/(?!\S+(?:jpe?g|png|bmp|gif|webp|jfif|gif))\S+/g;
    var re_forpic = /\bhttps?:[^:<>"]*\/([^:<>"]*)(\.(jpe?g)|(png)|(bmp)|(jfif)|(webp))/g;
    str = str.replace(re, function (website) {
        return '🔗';
    });
    str = str.replace(re_forpic, function (imgurl) {
        return '🌅';
    });
    //去掉 Share 标签
    var re_share = /(\#share)|(\#Share)/g;
    str = str.replace(re_share, '');
    return str;
}
// Lightest possible code
(function() {
    // var t0 = performance.now();
    setInterval(function() {
        var parent = document.querySelector('.talk-list');
        var slide = parent.querySelectorAll('.item');

        for (var i = 0; i < slide.length; i++) {
            var x = slide[i];
            x.classList.toggle('sliding-now');
        }

        setTimeout(function() {
            parent.appendChild(slide[0]);
        }, 2000);

        }, 2000);
        // var t1 = performance.now();
        // console.log("Carousel taking " + (t1 - t0) + " milliseconds.");
      })()
};
xhrTalks.send();
</script>

{{ end }}

{{/*  {{ if and (not .IsHome) (not (eq .Params.lightbox false)) }}  */}}
{{ if (not .IsHome) }}

<script type="text/javascript" src="/assets/baguetteBox.js?v=1.11.1" async></script>
<script>
    window.addEventListener('load', function() {
        baguetteBox.run('.gallery', {
            // Custom options
            buttons: false,
            noScrollbars: true,
            fullScreen: false,
            filter: /.*/i
        });
    });
</script>

{{ end }}

{{/*  DisqusJS comment  */}}
{{ if and .Site.Params.disqus.enable .Params.Comments }}
<script defer>
// lazyDisqus.js
function callback() {
    window.disqus_config = function () {
        this.page.url = '{{ if .Params.identifier }}"{{ trim .Site.BaseURL "/" }}{{ .Params.identifier }}"{{ else }}{{ .Permalink }}{{ end }}';
        this.page.identifier = '{{ if .Params.identifier }}{{ trim .Params.identifier "/" }}{{ else }}{{ trim .RelPermalink "/" }}{{ end }}';
    }
    const disqusjs = new DisqusJS({
        shortname: "eallion",
        siteName: "{{ .Site.Params.title }}",
        identifier: '{{ if .Params.identifier }}{{ trim .Params.identifier "/" }}{{ else }}{{ trim .RelPermalink "/" }}{{ end }}',
        url: '{{ if .Params.identifier }}"{{ trim .Site.BaseURL "/" }}{{ .Params.identifier }}"{{ else }}{{ .Permalink }}{{ end }}',
        title: "{{ .Title }}",
        api: "https://disqus.eallion.com/",
        apikey: "fF9m3DwDSmNQ2g5DIpuWElDaQTx1ofpMSSW8JeKaB2loVBExeInmMbaEGeLs7lOL",
        admin: "eallion",
        adminLabel: "Spectator",
        nocomment: "说点什么吧！你的评论也可一针见血！",
    });
    disqusjs.render(document.getElementById('disqusjs'));
}
/*
function addStyle(url) {
    var d = document.createElement('link');
    d.rel = 'stylesheet';
    d.href = url;
    document.head.appendChild(d);
}
*/
function addScript(url) {
    var d = document.createElement('script');
    d.src = url;
    d.async = false;
    document.body.appendChild(d);
    d.onload = () => {
        callback();
    }
}

function loadDisqus() {
    addScript('/assets/disqus.js?v=3.0.1');
    //addStyle('https://cdn.jsdelivr.net/npm/disqusjs@3.0/dist/browser/styles/disqusjs.css');
}

var runningOnBrowser = typeof window !== "undefined";
var isBot = runningOnBrowser && !("onscroll" in window) || typeof navigator !== "undefined" && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
var supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;

function loadDisqusjs () {
    if (!isBot && supportsIntersectionObserver) {
        var disqus_observer = new IntersectionObserver(function(entries) {
            if (entries[0].isIntersecting) {
                loadDisqus();
                disqus_observer.disconnect();
            }
        });
        disqus_observer.observe(document.getElementById('disqusjs'));
    } else {
        loadDisqus();
    }
    var eButton = document.getElementById('loadDisqusjs');
    eButton.remove();
};
</script>
{{ end }}
