<script type="text/javascript" src="/assets/main.js"></script>

{{ if not (eq .Params.gushici true) }}
<script>
    (() => {
        window.Lately = new function () {
            this.lang = {
                second: " 秒",
                minute: " 分钟",
                hour: " 小时",
                day: " 天",
                month: " 个月",
                year: " 年",
                ago: "前",
                error: "NaN"
            };
            const format = (date) => {
                date = new Date(_val(date));
                const floor = (num, _lang) => Math.floor(num) + _lang,
                    obj = new function () {
                        this.second = (Date.now() - date.getTime()) / 1000;
                        this.minute = this.second / 60;
                        this.hour = this.minute / 60;
                        this.day = this.hour / 24;
                        this.month = this.day / 30;
                        this.year = this.month / 12
                    },
                    key = Object.keys(obj).reverse().find(_ => obj[_] >= 1);
                return (key ? floor(obj[key], this.lang[key]) : this.lang.error) + this.lang.ago;
            },
                _val = (date) => {
                    date = new Date(date && (typeof date === 'number' ? date : date.replace(/-/g, '/').replace('T', ' ')));
                    return isNaN(date.getTime()) ? false : date.getTime();
                };
            return {
                init: ({ target = "time", lang } = {}) => {
                    if (lang) this.lang = lang;
                    for (let el of document.querySelectorAll(target)) {
                        const date = _val(el.dateTime) || _val(el.title) || _val(el.innerHTML) || 0;
                        if (!date) return;
                        el.title = new Date(date).toLocaleString();
                        el.innerHTML = format(date);
                    }
                },
                format
            }
        }
    })();
</script>
<script>
    let jsonUrl = "https://api.eallion.com/memos/memos.json" + "?t=" + Date.parse(new Date())

    fetch(jsonUrl).then(res => res.json()).then(resdata => {
        var result = '', resultAll = "", data = resdata.data
        for (var i = 0; i < data.length; i++) {
            var talkTime = new Date(data[i].createdTs * 1000).toLocaleString()
            var talkContent = data[i].content
            var newtalkContent = talkContent
                .replace(/```([\s\S]*?)```[\s]*/g, ' <code>$1</code> ')  //全局匹配代码块
                .replace(/`([\s\S ]*?)`[\s]*/g, ' <code>$1</code> ')  //全局匹配内联代码块
                .replace(/\!\[[\s\S]*?\]\(([\s\S]*?)\)/g, "$1")  //全局匹配图片
                .replace(/\[[\s\S]*?\]\(([\s\S]*?)\)/g, "$1")  //全局匹配连接
                .replace(/<video [^>]*src=['"](.+?[^'"]\.(mp4|webm|ogv)+)[^>]*>/g, "$1")  //全局匹配连接
            result += `<li class="item"><span class="datetime">${talkTime}</span>： <a href="https://eallion.com/memos/">${newtalkContent}</a></li>`;
        }
        var talkDom = document.querySelector('#index-talk');
        var talkBefore = `<i class="iconfont icon-line-quote"></i><div class="talk-wrap"><ul class="talk-list">`
        var talkAfter = `</ul></div>`
        resultAll = talkBefore + result + talkAfter
        talkDom.innerHTML = resultAll;

        // 相对时间： https://tokinx.github.io/lately/
        window.Lately && Lately.init({ target: '.datetime' });

    });

    setInterval(function () {
        var talkWrap = document.querySelector(".talk-list");
        var talkItem = talkWrap.querySelectorAll(".item");
        for (i = 0; i < talkItem.length; i++) {
            setTimeout(function () {
                talkWrap.appendChild(talkItem[0]);
            }, 2000);
        }
    }, 2000);

</script>

{{ end }}

{{ if (not .IsHome) }}

<script type="text/javascript" src="/assets/highlight.min.js?v=11.7.0"></script>
<script>
    hljs.configure({
        ignoreUnescapedHTML: true,
    })
    hljs.highlightAll();
</script>

<script type="text/javascript" src="/assets/view-image.min.js?v=2.0.2"></script>
<script>
    window.ViewImage && ViewImage.init('.content img');
</script>

{{ end }}


{{/* Twikoo comment */}}
{{ if and .Site.Params.twikoo.enable .Params.Comments }}
<script type="text/javascript" src="/assets/twikoo.min.js?v=1.6.8"></script>
<script>
    twikoo.init({
        envId: 'https://api.eallion.com/twikoo',
        el: '#tcomment',
        path: location.pathname,
        lang: 'zh-CN',
        onCommentLoaded: function () {
            hljs.highlightAll();
        }
    })
</script>
{{ end }}

{{/* DisqusJS comment */}}
{{ if and .Site.Params.disqus.enable .Params.Comments }}
<script defer>
    // lazyDisqus.js
    function callback() {
        window.disqus_config = function () {
            this.page.url = '{{ if .Params.identifier }}"{{ trim .Site.BaseURL "/" }}{{ .Params.identifier }}"{{ else }}{{ .Permalink }}{{ end }}';
            this.page.identifier = '{{ if .Params.identifier }}{{ trim .Params.identifier "/" }}{{ else }}{{ trim .RelPermalink "/" }}{{ end }}';
        }
        const disqusjs = new DisqusJS({
            shortname: "eallion",
            siteName: "{{ .Site.Params.title }}",
            identifier: '{{ if .Params.identifier }}{{ trim .Params.identifier "/" }}{{ else }}{{ trim .RelPermalink "/" }}{{ end }}',
            url: '{{ if .Params.identifier }}"{{ trim .Site.BaseURL "/" }}{{ .Params.identifier }}"{{ else }}{{ .Permalink }}{{ end }}',
            title: "{{ .Title }}",
            api: "https://disqus.eallion.com/",
            apikey: "fF9m3DwDSmNQ2g5DIpuWElDaQTx1ofpMSSW8JeKaB2loVBExeInmMbaEGeLs7lOL",
            admin: "eallion",
            adminLabel: "Spectator",
            nocomment: "说点什么吧！你的评论也可一针见血！",
        });
        disqusjs.render(document.getElementById('disqusjs'));
    }
    /*
    function addStyle(url) {
        var d = document.createElement('link');
        d.rel = 'stylesheet';
        d.href = url;
        document.head.appendChild(d);
    }
    */
    function addScript(url) {
        var d = document.createElement('script');
        d.src = url;
        d.async = false;
        document.body.appendChild(d);
        d.onload = () => {
            callback();
        }
    }

    function loadDisqus() {
        addScript('/assets/disqus.js?v=3.0.1');
        //addStyle('https://cdn.jsdelivr.net/npm/disqusjs@3.0/dist/browser/styles/disqusjs.css');
    }

    var runningOnBrowser = typeof window !== "undefined";
    var isBot = runningOnBrowser && !("onscroll" in window) || typeof navigator !== "undefined" && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
    var supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;

    function loadDisqusjs() {
        if (!isBot && supportsIntersectionObserver) {
            var disqus_observer = new IntersectionObserver(function (entries) {
                if (entries[0].isIntersecting) {
                    loadDisqus();
                    disqus_observer.disconnect();
                }
            });
            disqus_observer.observe(document.getElementById('disqusjs'));
        } else {
            loadDisqus();
        }
        var eButton = document.getElementById('loadDisqusjs');
        eButton.remove();
    };
</script>
{{ end }}
