{{- define "title" }}{{ .Title }} - {{ .Site.Title }}{{ end -}}

{{- define "content" -}}
{{- $params := .Scratch.Get "params" -}}
{{- $toc := $params.toc -}}
{{- if eq $toc true -}}
{{- $toc = .Site.Params.page.toc | default dict -}}
{{- else if eq $toc false -}}
{{- $toc = dict "enable" false -}}
{{- end -}}

<meta name="referrer" content="no-referrer">
<style>
    .album {
    column-count: 3;
    column-gap: 0.5rem;
    margin: 0;
    padding: 0;
    min-height: 5rem;
    position: relative;
    box-sizing: border-box;
    margin-bottom: 1rem;
}

.album_wrapper {
    margin: 0;
    break-inside: avoid;
    transition: transform 0.3s;
    overflow: hidden;
    border-radius: 0.25rem;
    position: relative;
    width: 33%;
}

.album_wrapper a,
.album_wrapper a:hover,
.album_wrapper a:active {
    color: #fff !important;
}

.album_wrapper img {
    display: block;
    width: 100%;
    animation: fadeIn 1s;
    cursor: pointer;
    transition: all 0.4s ease-in-out !important;
    border-radius: 0.25rem;
    transform: scale(1);
    object-fit: cover;
    height: 100%;
}

.album_wrapper:hover img {
    transform: scale(1.1);
}

.album_wrapper span.photo-title,
.album_wrapper span.photo-time {
    position: absolute;
    background: rgba(0, 0, 0, 0.3);
    font-size: 0.9rem;
    color: #fff;
    display: none;
    animation: fadeIn 1s;
    left: 0;
    padding: 0 0.25rem;
}

.album_wrapper span.photo-title {
    bottom: 0;
    border-radius: 0 0.25rem 0 0.25rem;
}

.album_wrapper span.photo-time {
    top: 0;
    border-radius: 0.25rem 0 0.25rem 0;
}

.album_wrapper:hover span.photo-title,
.album_wrapper:hover span.photo-time {
    display: block !important;
}

@keyframes fadeIn {
    0% {
        opacity: 0;
    }

    100% {
        opacity: 1;
    }
}

@media only screen and (max-width: 1000px) {
    .album {
        column-count: 2;
    }
    .album_wrapper {
        width: 49.5%;
    }
}

.packery-drop-placeholder {
    outline: 3px dashed hsla(0, 0%, 0%, 0.5);
    outline-offset: -6px;
    -webkit-transition: -webkit-transform 0.2s;
            transition: transform 0.2s;
}

[theme="dark"] .album_wrapper img {
    opacity: 0.75;
}

[theme="black"] .album_wrapper img {
    opacity: 0.5;
}

.gutter-sizer {
    width: 1%;
}
</style>

<article class="page single special">
    <h1 class="single-title animate__animated animate__pulse animate__faster">{{ .Title }}</h1>
    <div id="content" class="content">
        <div class="greyQuote">
            <blockquote>
                {{ T `album_quote` | safeHTML }} 🤡
            </blockquote>
        </div>
        <div id="album" class="album" view-image>
        </div>
    </div>
</article>

<script type="text/javascript" src="https://cdn.eallion.com/assets/js/packery.pkgd.min.js?v=4.2.2"></script>
<script type="text/javascript" src="https://cdn.eallion.com/assets/js/draggabilly.pkgd.min.js?v=3.0.0"></script>
<script type="text/javascript" src="https://cdn.eallion.com/assets/js/imagesloaded.pkgd.min.js?v=5.0.0"></script>
<script>
    var galleryUrl = "https://api.eallion.com/memos/api/v1/memo/all?rowStatus=NORMAL&tag=相册";
    let nowNum = 0;
    fetch(galleryUrl)
        .then((res) => res.json())
        .then((resdata) => {
            var result = "",
                resultAll = "",
                data = resdata;
            for (var i = 0; i < data.length; i++) {
                var galleryTitle = data[i].content.replace("#相册 ", "");
                var id = data[i].id;
                var imgs = galleryTitle.match(/\!\[(.*?)\s*(.*?)\]\((.*?)\)/g);
                //解析 content 内 md 格式图片
                if (imgs) {
                    imgs.forEach((item) => {
                        nowNum++;
                        let img = item.replace(/!\[.*?\]\((.*?)\)/g, "$1"),
                            time,
                            title,
                            tmp = item.replace(/!\[(.*?)\]\(.*?\)/g, "$1");
                        if (tmp.indexOf(" ") != -1) {
                            time = tmp.split(" ")[0];
                            title = tmp.split(" ")[1];
                        } else title = tmp;
                        result += `<div class="album_wrapper"><img loading="lazy" src="${img}" srcset="${img}, ${img} 1.5x, ${img} 2x" sizes="auto" alt="${title}" />`;
                        title
                            ? (result += `<span class="photo-title"><a href="https://memos.eallion.com/m/${id}" target="_blank" rel="noreferrer noopener nofollow">${title}</a></span>`)
                            : "";
                        time
                            ? (result += `<span class="photo-time">${time}</span>`)
                            : "";
                        result += `</div><div class="gutter-sizer"></div>`;

                    });
                }
            }

            var galleryDom = document.querySelector("#album");
            // var galleryBefore = `<div class="album">`;
            // var galleryAfter = `</div>`;
            resultAll = result;
            galleryDom.innerHTML = resultAll;

            // 初始化Masonry
            var pckry  = new Packery(galleryDom, {
                itemSelector: '.album_wrapper',
                columnWidth: '.album_wrapper',
                gutter: '.gutter-sizer',
                percentPosition: true,

            });


            pckry.getItemElements().forEach(function (itemElem) {
                var draggie = new Draggabilly(itemElem);
                pckry.bindDraggabillyEvents(draggie);
            });

            // 图片加载完成后触发
            imagesLoaded(galleryDom).on('progress', function () {

                // 定义块状网格尺寸
                galleryDom.classList.add('grid');

                // 重排布局
                pckry.layout();

                // Images done loading
                pckry.options.itemSelector = '.album_wrapper';
            });

            // 相对时间
            window.Lately && Lately.init({ target: ".photo-time" });
        });
</script>

{{- end -}}
